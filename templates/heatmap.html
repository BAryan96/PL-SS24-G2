<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualisation - DV</title>
    <link rel="stylesheet" href="/static/CSS/all.css">
    <link rel="stylesheet" href="/static/CSS/stacked_chart_type.css">
    <link rel="stylesheet" href="/static/CSS/charts.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
     .color-picker {
            margin: 10px 0;
        }
        #submitButton {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: coral;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #submitButton:hover {
            background-color: #ff6f61; 
        }
        .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: red;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        .close-btn:hover {
            background-color: darkred;
        }
        .options-menu {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }
        .data-selection {
            display: flex;
            width: 100%;
            justify-content: space-between;        
        }
        .form-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .form-container label, .form-container select, .form-container button {
            width: 100%;
            margin-bottom: 10px;
        }
        .chart-container #chart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <span class="logo-circle"></span>
                <span class="logo-text">Data Visualisation - DV</span>
            </div>
            <button class="menu-button">â˜°</button>
        </header>
        <main class="main">
            <section class="data-selection">
                <form id="dataForm" class="form-container">
                    <div>
                        <h2>Please Choose your Data for a Heatmap</h2>
                        <label for="tableSelect">Table</label>
                        <select id="tableSelect" name="tableSelect">
                            <option value="">None</option>
                        </select>
                        <label for="columnSelect">Column</label>
                        <select id="columnSelect" name="columnSelect">
                            <option value="">None</option>
                        </select>
                        <label for="aggregationSelect">Aggregation</label>
                        <select id="aggregationSelect" name="aggregationSelect">
                            <option value="">No Aggregation</option>
                            <option value="Summe">Sum</option>
                            <option value="Max">Max</option>
                            <option value="Min">Min</option>
                            <option value="Anzahl">Count</option>
                            <option value="Diskrete Anzahl">Distinct Count</option>
                            <option value="Durchschnitt">Average</option>
                            <option value="Standardabweichung">Standard deviation</option>
                            <option value="Varianz">Variance</option>
                            <option value="Median">Median</option>
                            <option value="Erstes Quartil">Q1 Quartile</option>
                            <option value="Drittes Quartil">Q3 Quartile</option>
                        </select>
                        <button type="submit" id="submitButton">Submit</button>
                    </div>
                </form>
                <div class="chart-container">
                    <div id="chart"></div>
                </div>
            </section>
        </main>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/heatmap.js"></script>
    <script src="https://unpkg.com/leaflet-heatmap/leaflet-heatmap.js"></script>
    <script>
        let chart;

        $(document).ready(function () {
            // Load available tables from backend
            $.get("/tables", function (data) {
                const availableTables = data.tables;
                availableTables.forEach(table => {
                    $('#tableSelect').append(`<option value="${table}">${table}</option>`);
                });
            });

            $('#tableSelect').change(function () {
                const table = $(this).val();
                if (table) {
                    $.post("/columns", { table: table }, function (data) {
                        $('#columnSelect').empty().append(`<option value="">None</option>`);
                        data.columns.forEach(column => {
                            $('#columnSelect').append(`<option value="${column}">${column}</option>`);
                        });
                    });
                }
            });

            $('#dataForm').submit(function (e) {
                e.preventDefault();
                const table = $('#tableSelect').val();
                const column = $('#columnSelect').val();
                const aggregation = $('#aggregationSelect').val();

                if (table && column && aggregation) {
                    const requestData = {
                        tables: [table, 'stores'],
                        columns: [column, 'storeID'],
                        chartType: "heatmap",
                        aggregations: [aggregation, ""]
                    };

                    $.ajax({
                        url: "/getdata",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(requestData),
                        success: function (response) {
                            // Assuming response has store locations with counts of order IDs
                            const data = response.dataX.map((store, index) => [
                                store.latitude, 
                                store.longitude, 
                                response.dataY[index]
                            ]);
                            createHeatmap(data);
                        },
                        error: function (xhr, status, error) {
                            console.error("Error: ", status, error);
                        }
                    });
                } else {
                    alert('Please select Table, Column, and Aggregation.');
                }
            });
        });

        function createHeatmap(data) {
            if (chart) {
                chart.remove();
            }
            chart = L.map('chart').setView([20.0, 0.0], 2); // Set view to show the whole world

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(chart);

            const heat = L.heatLayer(data, { 
                radius: 25, 
                blur: 15, 
                maxZoom: 17, 
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'} // Customize the gradient colors if needed
            }).addTo(chart);
        }
    </script>
</body>

</html>
