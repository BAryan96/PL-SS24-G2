<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualisation - DV</title>
    <link rel="stylesheet" href="/static/CSS/all.css">
    <link rel="stylesheet" href="/static/CSS/charts.css">
    <style>
      #submitButton {
    margin-top: 10px;
    padding: 12px 24px;
    font-size: 16px;
    color: #fff;
    background-color: coral;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
#submitButton:hover {
    background-color: #ff704d;
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
}

.hidden { display: none; }



.close-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: red;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease;
}

.close-btn:hover {
    background-color: darkred;
}

.options-menu {
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.color-picker {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.data-selection {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 20px;
}

.form-container {
    display: flex;
    width: 100%;
}

.form-container > div {
    flex: 1;
    margin-right: 20px;
}

.chart-container {
    flex: 1;
    height: 600px; /* Festgelegte Höhe für den Chart-Container */
}

.chart-container #chart {
    width: 100%;
    height: 100%;
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <span class="logo-circle"></span>
                <span class="logo-text">Data Visualisation - DV</span>
            </div>
            <button class="menu-button">☰</button>
        </header>
        <div class="side-menu" id="sideMenu">
            <button class="close-button">X</button>
            <h1>What would you like to See?</h1>
            <a href="/charts">Chart Overview</a>
            <a href="#">Edit/Clear Data</a>
            <a href="#">Forecast</a>
            <a href="#">My Profile</a>
            <a href="/login">Sign In</a>
            <a href="/">Log Out</a>
        </div>
        <main class="main">
            <section class="data-selection">
                <form id="dataForm" class="form-container">
                    <div>
                        <h2>Please Choose your Data for a Stacked Area Chart</h2>
                        <label for="xTable">Table for X-Axis</label>
                        <select id="xTable" name="xTable">
                            <option value="">None</option>
                        </select>

                        <label for="xColumn">Column for X-Axis</label>
                        <select id="xColumn" name="xColumn">
                            <option value="">None</option>
                        </select>

                        <label for="yTable1">Table for Y-Axis 1</label>
                        <select id="yTable1" name="yTable1">
                            <option value="">None</option>
                        </select>

                        <label for="yColumn1">Column for Y-Axis 1</label>
                        <select id="yColumn1" name="yColumn1">
                            <option value="">None</option>
                        </select>

                        <div id="additionalInputs" class="hidden">
                            <label for="yTable2">Table for Y-Axis 2</label>
                            <select id="yTable2" name="yTable2">
                                <option value="">None</option>
                            </select>

                            <label for="yColumn2">Column for Y-Axis 2</label>
                            <select id="yColumn2" name="yColumn2">
                                <option value="">None</option>
                            </select>
                        </div>

                        <label for="aggregationSelect">Aggregation</label>
                        <select id="aggregationSelect" name="aggregationSelect">
                            <option value="">No Aggregation</option>
                            <option value="Summe">Sum</option>
                            <option value="Max">Max</option>
                            <option value="Min">Min</option>
                            <option value="Anzahl">Count</option>
                            <option value="Diskrete Anzahl">Distinct Count</option>
                            <option value="Durchschnitt">Average</option>
                            <option value="Standardabweichung">Standard deviation</option>
                            <option value="Varianz">Variance</option>
                            <option value="Median">Median</option>
                            <option value="Erstes Quartil">Q1 Quartile</option>
                            <option value="Drittes Quartil">Q3 Quartile</option>
                        </select>

                        <button type="submit" id="submitButton">Submit</button>
                    </div>
                    <div class="chart-container">
                        <div id="chart"></div>
                    </div>
                </form>
            </section>
        </main>
    </div>
    <script src="/static/JS/sidemenu.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let chartInstance = null;
        let darkMode = false;
        let decalPattern = false;
        let filter = [];
        let highlightedPoints = {};
        let updateQueue = [];
        let updating = false;

        $(document).ready(function() {
            $.get("/tables", function(data) {
                window.availableTables = data.tables;
                populateSelectOptions();
            });

            $('#dataForm').on('submit', function(event) {
                event.preventDefault();
                addChart();
            });

            $('#xTable').on('change', function() {
                loadColumns($(this).val(), '#xColumn');
            });

            $('#yTable1').on('change', function() {
                loadColumns($(this).val(), '#yColumn1');
            });

            $('#yTable2').on('change', function() {
                loadColumns($(this).val(), '#yColumn2');
            });
        });

        function populateSelectOptions() {
            availableTables.forEach(table => {
                $('#xTable, #yTable1, #yTable2').append(`<option value="${table}">${table}</option>`);
            });
        }

        function loadColumns(table, columnSelect) {
            if (table) {
                $.post("/columns", { table: table }, function(data) {
                    const columnDropdown = $(columnSelect);
                    columnDropdown.html('<option value="">None</option>');
                    data.columns.forEach(column => {
                        columnDropdown.append(`<option value="${column}">${column}</option>`);
                    });
                });
            }
        }

        function addChart() {
            if (chartInstance) {
                chartInstance.dispose();
            }

            const chartContainer = document.getElementById('chart');
            chartContainer.innerHTML = '';

            chartInstance = echarts.init(chartContainer);

            const table1 = $('#yTable1').val();
            const column1 = $('#yColumn1').val();
            const table2 = $('#xTable').val();
            const column2 = $('#xColumn').val();
            const aggregationType = $('#aggregationSelect').val();

            const requestData = {
                tables: [table2, table1], 
                columns: [column2, column1], 
                chartType: 'stacked',
                aggregations: ["", aggregationType],
                filters: filter
            };

            $.ajax({
                url: "/getdata",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(requestData),
                success: function(response) {
                    const series = [{
                        name: column1,
                        type: 'line',
                        stack: 'total',
                        areaStyle: decalPattern ? { decal: { symbol: 'rect' } } : {},
                        data: response.dataY.map((y, index) => {
                            const xValue = response.dataX[index];
                            const key = `${chartInstance.id}-${xValue}`;
                            const isHighlighted = highlightedPoints[key];
                            return {
                                value: y,
                                itemStyle: {
                                    borderColor: isHighlighted ? 'black' : null,
                                    borderWidth: isHighlighted ? 2 : 0,
                                    color: response.colors ? response.colors[index] : null
                                }
                            };
                        })
                    }];

                    const option = {
                        title: {
                            left: 'center',
                            text: 'Stacked Area Chart'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        legend: {
                            data: [column1],
                            top: '5%'
                        },
                        xAxis: {
                            type: 'category',
                            name: column2, 
                            boundaryGap: false,
                            data: response.dataX
                        },
                        yAxis: {
                            type: 'value',
                            name: column1 
                        },
                        series: series,
                        backgroundColor: darkMode ? '#333' : '#fff',
                        textStyle: { color: darkMode ? '#fff' : '#000' },
                        toolbox: {
                            feature: {
                                saveAsImage: {},
                                myDarkMode: {
                                    show: true,
                                    title: 'Dark Mode',
                                    icon: 'path://M512 0C229.23072 0 0 229.23072 0 512s229.23072 512 512 512 512-229.23072 512-512S794.76928 0 512 0z m0 938.0864c-234.24 0-426.0864-191.8464-426.0864-426.0864S277.76 85.9136 512 85.9136c55.7312 0 111.4624 11.7248 163.6864 35.0208-32.768 56.32-87.04 94.72-151.0912 105.2672-78.4896 13.7216-147.2-12.288-199.7312-55.808 0 0-12.6976 80.9472-12.6976 119.296 0 136.3968 104.7552 247.9104 239.9232 261.8368 79.872 8.2944 152.576-24.7808 198.3488-80.64 28.2624 48.64 45.568 106.752 45.568 170.3424 0 234.24-191.8464 426.0864-426.0864 426.0864z',
                                    onclick: function() {
                                        darkMode = !darkMode;
                                        updateChartAppearance();
                                    }
                                },
                                myDecalPattern: {
                                    show: true,
                                    title: 'Decal Pattern',
                                    icon: 'path://M50 250 Q 150 50 250 250 T 450 250',
                                    onclick: function() {
                                        decalPattern = !decalPattern;
                                        updateChartAppearance();
                                    }
                                },
                                myShare: {
                                    show: true,
                                    title: 'Share',
                                    icon: 'path://M864 160h-192V96H352v64H160c-35.328 0-64 28.672-64 64v576c0 35.328 28.672 64 64 64h704c35.328 0 64-28.672 64-64V224c0-35.328-28.672-64-64-64z m0 640H160V224h192v64h320v-64h192v576z m-320-320h-64v192h-192V480h-64l160-160 160 160z',
                                    onclick: function() {
                                        const url = window.location.href;
                                        navigator.clipboard.writeText(url).then(function() {
                                            alert('URL copied to clipboard');
                                        }, function(err) {
                                            console.error('Could not copy URL: ', err);
                                        });
                                    }
                                }
                            }
                        },
                        dataZoom: [
                            {
                                type: 'inside',
                                start: 0,
                                end: 100
                            },
                            {
                                start: 0,
                                end: 100
                            }
                        ]
                    };

                    chartInstance.setOption(option);
                    processQueue();
                },
                error: function(xhr, status, error) {
                    console.error("Error: ", status, error);
                    processQueue();
                }
            });

            chartContainer.addEventListener('contextmenu', function(event) {
                event.preventDefault();
            });

            chartInstance.on('contextmenu', function(params) {
                if (params.componentType === 'series') {
                    showColorPicker(params.event.event, chartInstance, params.dataIndex);
                }
            });

            chartContainer.addEventListener('mousedown', function(event) {
                draggedElement = chartContainer;
                offsetX = event.clientX - chartContainer.getBoundingClientRect().left;
                offsetY = event.clientY - chartContainer.getBoundingClientRect().top;
            });

            document.addEventListener('mousemove', function(event) {
                if (draggedElement) {
                    draggedElement.style.left = `${event.clientX - offsetX}px`;
                    draggedElement.style.top = `${event.clientY - offsetY}px`;
                }
            });

            document.addEventListener('mouseup', function() {
                draggedElement = null;
            });

            chartInstance.on('click', function(params) {
                if (params.componentType === 'series') {
                    const key = `${chartInstance.id}-${params.dataIndex}`;
                    const value = params.value[0] || params.name;

                    if (highlightedPoints[key]) {
                        delete highlightedPoints[key];
                        filter = filter.filter(item => item.filterValue !== value);
                    } else {
                        highlightedPoints[key] = true;
                        filter.push({
                            chartId: chartInstance.id,
                            filterTable: table2,
                            filterColumn: column2,
                            filterValue: value
                        });
                    }

                    updateHighlighting(chartInstance);
                    queueUpdateChart(chartInstance);
                }
            });

            function updateHighlighting(chartInstance) {
                const series = chartInstance.getOption().series;
                series.forEach(serie => {
                    serie.data.forEach((dataPoint, index) => {
                        const key = `${chartInstance.id}-${index}`;
                        if (highlightedPoints[key]) {
                            dataPoint.itemStyle = dataPoint.itemStyle || {};
                            dataPoint.itemStyle.borderColor = 'black';
                            dataPoint.itemStyle.borderWidth = 2;
                        } else {
                            if (dataPoint.itemStyle) {
                                delete dataPoint.itemStyle.borderColor;
                                delete dataPoint.itemStyle.borderWidth;
                            }
                        }
                    });
                });

                chartInstance.setOption({
                    series: series
                });
            }

            function showColorPicker(event, chartInstance, dataIndex) {
                const optionsMenu = document.createElement('div');
                optionsMenu.className = 'options-menu';

                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.className = 'color-picker';
                colorPicker.addEventListener('input', function () {
                    const option = chartInstance.getOption();
                    option.series[0].data[dataIndex].itemStyle = { 
                        color: colorPicker.value,
                        borderColor: option.series[0].data[dataIndex].itemStyle.borderColor,
                        borderWidth: option.series[0].data[dataIndex].itemStyle.borderWidth
                    };
                    chartInstance.setOption(option);
                });

                colorPicker.addEventListener('change', function () {
                    document.body.removeChild(optionsMenu);
                });

                optionsMenu.appendChild(colorPicker);
                document.body.appendChild(optionsMenu);
                optionsMenu.style.position = 'absolute';
                optionsMenu.style.left = `${event.pageX}px`;
                optionsMenu.style.top = `${event.pageY}px`;
                optionsMenu.style.zIndex = 1000;

                document.addEventListener('click', function removeOptionsMenu(event) {
                    if (!optionsMenu.contains(event.target)) {
                        document.body.removeChild(optionsMenu);
                        document.removeEventListener('click', removeOptionsMenu);
                    }
                }, { once: true });
            }
        }

        function queueUpdateChart(chartInstance) {
            updateQueue.push(chartInstance);
            if (!updating) {
                updating = true;
                processQueue();
            }
        }

        function processQueue() {
            if (updateQueue.length > 0) {
                const nextChart = updateQueue.shift();
                updateChart(nextChart);
            } else {
                updating = false;
            }
        }

        function updateChart(chartInstance) {
            const xAxisType = chartInstance.xAxisType;
            const yAxisType = chartInstance.yAxisType;
            const aggregationType = chartInstance.aggregationType;

            if (xAxisType && yAxisType) {
                let requestData = { 
                    tables: [chartInstance.table1, chartInstance.table2], // Reihenfolge angepasst
                    columns: [xAxisType, yAxisType], // Reihenfolge angepasst
                    chartType: chartInstance.chartType,
                    aggregations: ["", aggregationType],
                    filters: filter.filter(f => f.chartId !== chartInstance.id)
                };

                $.ajax({
                    url: "/getdata",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        const option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            xAxis: {
                                type: 'category',
                                name: xAxisType, // Verwende den Namen der X-Spalte für die Achsenbeschriftung
                                data: response.dataX
                            },
                            yAxis: {
                                type: 'value',
                                name: yAxisType // Verwende den Namen der Y-Spalte für die Achsenbeschriftung
                            },
                            series: [{
                                data: response.dataY.map((y, index) => {
                                    const xValue = response.dataX[index];
                                    const key = `${chartInstance.id}-${xValue}`;
                                    const isHighlighted = highlightedPoints[key];
                                    return {
                                        value: y,
                                        itemStyle: {
                                            borderColor: isHighlighted ? 'black' : null,
                                            borderWidth: isHighlighted ? 2 : 0,
                                            color: response.colors ? response.colors[index] : null
                                        }
                                    };
                                }),
                                type: 'line',
                                stack: 'total',
                                areaStyle: {}
                            }]
                        };

                        chartInstance.setOption(option);
                        processQueue();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error: ", status, error);
                        processQueue();
                    }
                });
            } else {
                processQueue();
            }
        }

        function updateChartAppearance() {
            if (chartInstance) {
                chartInstance.setOption({
                    backgroundColor: darkMode ? '#333' : '#fff',
                    textStyle: { color: darkMode ? '#fff' : '#000' },
                    series: chartInstance.getOption().series.map(serie => ({
                        ...serie,
                        areaStyle: decalPattern ? { decal: { symbol: 'rect' } } : {}
                    }))
                });
            }
        }
    </script>
</body>
</html>
